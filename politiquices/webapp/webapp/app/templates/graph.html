{% extends 'base.html' %}

{% block title %} Grafo de Relações {% endblock %}

{% block body %}

<style type="text/css">
    #viz {
        width: 1125px;
        height: 650px;
        border: 1px solid lightgray;
        font: 6pt arial;
    }
</style>
<script src="static/vendor/neovis/neovis.js"></script>
<script>
    
    var viz; // needs to be defined becoming a global, so that it can be called from the bottom
    var ip_address = {{ ip_address|tojson }};
    var url = `bolt://${ip_address}:7687.`

    function draw() {
        var config = {
            container_id: "viz",
            server_url: url,
            server_user: "neo4j",
            server_password: "s3cr3t",
            arrows: true,

            hierarchical: true,

            labels: {
                "Person": {
                    caption: "name",
                    //size: "pagerank",
                    //community: "community"
                }
            },

            relationships: {
                "ACUSA": {
                    caption: true,
                    thickness: "freq",
                },
                "APOIA": {
                    caption: true,
                    thickness: "freq",
                }
            },
            //initial_cypher: "MATCH p=(:Person)-[r:ACUSA|APOIA]->(p1:Person { id: 'Q182367' }) WHERE r.freq > 5 RETURN p LIMIT 250"
            initial_cypher: "MATCH (n)-[r:ACUSA|APOIA]->(m) WHERE r.freq > 5 RETURN n,r,m"
        }
    
        viz = new NeoVis.default(config);
        viz.render();
        //console.log(viz);
    };

    /* select a personality */
    $(function() {
      $("#autocomplete_person").autocomplete({
        source: nomes,  // nomes is initialized in base.html
        focus: function(event, ui) {
            event.preventDefault();
            $(this).val(ui.item.label);
        },
        select: function(event, ui) {
            event.preventDefault();
            $(this).val(ui.item.label);
            $("#autocomplete_person_value").val(ui.item.value);            
        }
      });
    });

</script>

<body onload="draw()">
    <div class="container">
        <div class="row">
            <!--
            <div class="col-xs-6">
                <br>
                <input id="autocomplete_person" class="span10" type="text" placeholder="Personalidade"/>
                <input id="autocomplete_person_value" type="hidden" name="wiki">
                <input type="text" id="freq"/>
                <input type="submit" value="Actualizar" id="reload"/>
                <br>
            </div>
            -->
            <div class="col-xs-6">
                <div id="viz"></div>
            </div>
        </div>
    </div>

    
    
</body>

<script>
    $("#reload").click(function() {
        var edge_weight = $("#freq").val();
        var wiki_id = $("#autocomplete_person_value").val();
        
        //var query = `MATCH p=(:Person)-[r:ACUSA|APOIA]->(p1:Person { id: '${wiki_id}' }) WHERE r.freq > ${edge_weight} RETURN p LIMIT 250`
        
        var query = `
            MATCH p1=(:Person)-[r1:ACUSA|APOIA]->(p:Person { id: '${wiki_id}' }) 
            MATCH (p:Person { id: '${wiki_id}' })-[r2:ACUSA|APOIA]->(p2:Person) RETURN p1,p2,r1,r2
            `
        
        console.log(query);     
        viz.renderWithCypher(query);
        //console.log("reload");
        //viz.reload();
        }
    );
</script>

{% endblock %}